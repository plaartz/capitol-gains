stages:
  - build
  - test

build-docker:
  stage: build
  tags:
    - csl
    - docker
  image: docker:latest
  services: 
    - name: docker:dind
  before_script:
    - docker info
  script:
    - docker build -t app-image -f api/Dockerfile api/
  artifacts:
    paths:
      - docker_image.tar
  after_script:
    - docker save app-image > docker_image.tar

pytest:
  stage: test
  tags:
    - csl
  image: docker:latest
  services:
    - name: docker:dind
  before_script:
    - docker-compose up --build -d
  script:
    - pytest --maxfail=1 --disable-warnings test/conftest.py
  artifacts:
    when: always
    untracked: true
    expire_in: 7 days
    paths:
      - pytest-results.log
  coverage: /TOTAL.+?(\d+%)/